<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">
<head>
<meta charset="UTF-8">
<title>empMng.html(CRUD)</title>
<style>
	table, th, td {
		border: 1px solid black;
		border-collapse: collapse;
		text-align: center;
	}
</style>
</head>
<body>
	<div layout:fragment="content">
		<h3>사원목록</h3>
		<div>
			<table>
				<thead>
					<tr>
						<th>No</th>
						<th>employee_id</th>
						<th>name</th>
						<th>hire_date</th>
						<th>salary</th>
						<th>bonus</th>
						<th>수정/삭제</th>
					</tr>
				</thead>
				<tbody id="emplist">
<!-- 
					<tr>
						<td>1</td>
						<td>100</td>
						<td>scott</td>
						<td>2023-10-10</td>
						<td>100000</td>
						<td><button>신청</button>
							<button>신청불가</button></td>
						<td><button type="button" onclick="move(100)">조회</button></td>
					</tr> 
-->
				</tbody>
			</table>
		</div>

		<h3>사원(등록, 조회)</h3>
		<form method="post" name="frm">
			<label>last_name</label> <input name="lastName"> <br> 
			<label>jobId</label>
			<select name="jobId">
				<option value="IT_PROG">Programmer</option>
				<option value="ST_MAN">Stock Manager</option>
			</select> <br> 
			<label>입사일</label> <input type="text" name="hireDate"><br>
			<label>이메일</label> <input name="email"> <br>
			<div>
				<button type="button" onclick="saveReq()">등록</button>
			</div>
		</form>
		<script>
			listReq()
		
			function dateFormat(dt){
				let	date = new Date(dt);
				let result = date.getFullYear() + '-' + ((date.getMonth()+1) <= 9 ? "0" + (date.getMonth()+1) : (date.getMonth()+1))
						+ '-' + ((date.getMonth()+1) <= 9 ? "0" + (date.getMonth()+1) : (date.getMonth()+1));
				return result;				
			}
			
			// 상세조회 요청
			function infoReq(empId){
				fetch(`/ajax/emp/${empId}`)
					.then(res => res.json())
					.then(res => infoRes(res))
			}
			
			// 상세조회 응답
			function infoRes(res){
				// input tag에 표시
				frm.email.value = res.email;
				frm.lastName.value = res.lastName;
				frm.jobId.value = res.jobId;
				frm.hireDate.value = res.hireDate;
			}
			
			// 리스트 요청
			function listReq(){
				fetch("/ajax/empList")
					.then(res => res.json())
					.then(res => listRes(res))				
			}
				
			// 리스트 응답
			function listRes(res){
				emplist.innerHTML = '';
				let i = 0;
				for(obj of res){
					let bonusBtn = '<button>신청</button>'
					if(obj.salary > 10000){
						bonusBtn = '<button>신청불가</button>'
					}
					let newTag=`
					<tr>
						<td>${++i}</td>
						<td onclick="infoReq(${obj.employeeId})">${obj.employeeId}</td>
						<td>${obj.firstName} ${obj.lastName}</td>
						<td>${dateFormat(obj.hireDate)}</td>
						<td>${obj.salary}</td>
						<td>${bonusBtn}</td>
						<td><button type="button" onclick="move(${obj.employeeId})">조회</button></td>
					</tr>`
					emplist.innerHTML += newTag;
				}
			}
			
			// 등록 요청
			function saveReq(){
				// 1. queryString
//				const lastName=frm.lastName.value;
//				const email=frm.email.value;
//				const hireDate=frm.hireDate.value;
//				const jobId=frm.jobId.value;
//				let param = `lastName=${lastName}&email=${email}&hireDate=${hireDate}&jobId=${jobId}`;
				
//				fetch("/ajax/emp", {
//					method : "post" ,
//					body : param,
//					headers: {
//						'Content-Type': 'application/x-www-form-urlencoded',
//					},
//				})

				// 2. FormData 
//				let param = new FormData(document.frm);
//				fetch("/ajax/emp",{
//					method : "post",
//					body : param
//				})

			// 3. JsonString  ( payload )
			const lastName = frm.lastName.value;
			const email = frm.email.value;
			const jobId = frm.jobId.value;
			const hireDate = frm.hireDate.value;
			let param = {lastName, email, jobId, hireDate}
			fetch("/ajax/emp",{
				method : "post",
				headers: {
		      		"Content-Type": "application/json",
		    		},
				body : JSON.stringify(param)
				})
				.then(res => res.json())
				.then(res => saveRes(res))
			}
			
			//등록 응답
			function saveRes(res){
				listReq()
			}
			
			function move(empId){
				console.log(empId);
			}
		</script>
	</div>
</body>
</html>